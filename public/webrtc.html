<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <script src="javascripts/RTCMultiConnection-v1.3.js"></script>
    <script>

document.addEventListener("DOMContentLoaded", function () {
  var sessionWang = "wtf12333";
  var sender = Math.round(Math.random() * 60535) + 5000;
  var connection = new RTCMultiConnection();
  connection.session = {
    audio: true,
    video: true
  };
  /*
  connection.autoCloseEntireSession = true;
  //connection.transmitRoomOnce = false;
  connection.userid = sender; // username or user-id!
  connection.direction = 'many-to-many';
  */

  connection.openSignalingChannel = function(config) {

    var channel = config.channel || this.channel || 'Default-Socket';

    console.log("openSignalingChannel", channel, sender, config);

    //io.connect(URL).emit('new-channel', {
    //  channel: channel,
    //  sender : sender
    //});

    //socket = io.connect(URL + channel);

    var socket = {
    };

    socket.send = function (message) {
      console.log("need to send", JSON.stringify(message));
    //  socket.emit('message', {
    //    sender: sender,
    //    data  : message
    //  });
    };

    if (config.callback) {
      console.log("setting socket");
      //config.callback(socket);
      setTimeout(config.callback, 1, socket);
    }

    if (config.onopen) {
      setTimeout(config.onopen, 1);
    }

    document.getElementById("baz").onclick = function() {
      console.log("faking onmessage");
      //socket.on('message', config.onmessage);
      //config.onmessage("{sessionid: '123', userid: 'wang'}");
      //config.onmessage('{"sessionid":"wtf12333","userid":"DHH1I699-C4BO6R","session":{"audio":true,"video":true},"extra":{}}');
      config.onmessage({"sessionid":"wtf12333","userid":"DHH1I699-C4BO6R","session":{"audio":true,"video":true},"extra":{}});
    };
  };

/*
  connection.onopen = function(e) {
      // e.userid
    debugger;
  };

  connection.onclose = function(e) {
      // e.userid
    debugger;
  };

  connection.onerror = function(e) {
      // e.userid
    debugger;
  };
  */

  // get access to local or remote streams
  connection.onstream = function (e) {
    console.log("onstream", e);
    //if (e.type === 'local') mainVideo.src = e.blobURL;
    //if (e.type === 'remote') document.body.appendChild(e.mediaElement);
    document.body.appendChild(e.mediaElement);
  };

  /*
  connection.onmessage = function(e) {
      // e.userid
    debugger;
  };

  connection.onNewSession = function(session) {
      // session.extra -- extra data you passed or {}
      // session.sessionid -- it is session's unique identifier
      // session.userid -- it is room owner's id
      // session.session e.g. {audio:true, video:true}
    console.log("on new session", session);
  };
  */

  // searching/connecting pre-created session
  //connection.connect('session-id');

  document.getElementById("foo").onclick = function() {
    // to create/open a new session
    // it should be called "only-once" by the session-initiator
    connection.open(sessionWang);
  };

  document.getElementById("bar").onclick = function() {
    connection.connect(sessionWang);
  };
});
      
    </script>
  </head>
  <body>
    <button id="foo">foo</button>
    <button id="bar">bar</button>
    <button id="baz">baz</button>
    <a href="https://github.com/muaz-khan/WebRTC-Experiment/tree/master/RTCMultiConnection">wtf</a>
    <a href="https://webrtc-experiment.appspot.com/RTCMultiConnection/video-conferencing/#1S4KY7VV-DE4GQFR">wtf2</a>
  </body>
</html>
